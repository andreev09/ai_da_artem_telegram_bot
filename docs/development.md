# Процессы разработки

Этот документ описывает практические шаги для локальной работы с проектом: подготовку окружения, запуск приложения, тестирование и обслуживание вспомогательных файлов.

## Предварительные требования

- Python 3.11+ (используются аннотации `|` и `from __future__ import annotations`).
- Системные библиотеки для сборки пакетов Python (Linux: `build-essential`, `libffi-dev`, `libxml2-dev`, `libxslt-dev` при необходимости).
- LibreOffice 7+ с CLI `soffice` (достаточно headless-пакета, если доступны метапакеты дистрибутива).
- Установленное и активированное виртуальное окружение (`python -m venv .venv && source .venv/bin/activate`).
- Доступ к Telegram Bot API (токен, выданный `@BotFather`) — обязателен для сценариев скачивания/отправки файлов.

## Установка зависимостей

### Python-пакеты

```bash
pip install --upgrade pip
pip install -r requirements.txt
```

`requirements.txt` включает зависимости вебхука и вспомогательных утилит. Конвертация Excel выполняется внешним CLI, поэтому дополнительных Python-библиотек не требуется.

### LibreOffice (`soffice`)

Установите LibreOffice с поддержкой headless-режима. На популярных платформах подойдут следующие команды:

```bash
# Debian/Ubuntu
sudo apt update && sudo apt install -y libreoffice

# macOS (Homebrew)
brew install --cask libreoffice
```

Проверьте, что бинарник доступен:

```bash
soffice --headless --version
```

Если `soffice` лежит в нестандартной директории, добавьте её в `PATH` или задайте путь явно:

```bash
export SOFFICE_BIN=/opt/libreoffice/program/soffice
# или
export PATH="/opt/libreoffice/program:$PATH"
```

Эти переменные понадобятся как при запуске приложения, так и во время тестов.

## Запуск приложения

Минимальный запуск (использует `main.py`, где подключён полноценный обработчик вебхуков):

```bash
export TELEGRAM_BOT_TOKEN="<ваш_бот_токен>"   # нужен для сценариев с файлами
export FLASK_APP=main.py
flask run --host=0.0.0.0 --port=8000
```

Или напрямую через Python:

```bash
python main.py
```

Эндпоинты:

- `POST /webhook` — принимает апдейты Telegram.
- `GET /` — health-check, возвращает `{ "status": "running" }`.

При развёртывании убедитесь, что Telegram настроен на ваш публичный URL (`webhook_setup.py` можно использовать как пример скрипта регистрации вебхука).

## Тестирование

Проект поставляется с юнит- и интеграционными тестами. Рекомендуем использовать `pytest`, чтобы корректно обрабатывались и `assert`, и `unittest`-классы:

```bash
pytest
```

Альтернативно можно запустить стандартный `unittest`:

```bash
python -m unittest
```

Тест `tests/test_xls_converter.py` использует внешний CLI. Убедитесь, что `soffice` доступен по умолчанию или укажите путь через `SOFFICE_BIN`, прежде чем запускать его отдельно:

```bash
SOFFICE_BIN=/opt/libreoffice/program/soffice pytest tests/test_xls_converter.py
```

Запускайте весь набор тестов перед коммитами и после значимых изменений текстов или конвертера Excel.

## Работа с текстами

- Основные тексты живут в `texts.json`. Структура файла:
  ```json
  {
    "greeting_text": "Приветствие",
    "authorize_button_text": "Подпись кнопки",
    "contact_saved_template": "Шаблон {contact_label}"
  }
  ```
- Если файл отсутствует или повреждён, используются значения `DEFAULT_TEXTS` из `texts.py`.
- Шаблон `contact_saved_template` поддерживает плейсхолдер `{contact_label}`. Если форматирование падает, код автоматически подставит дефолтный шаблон.

## Хранение контактов

По умолчанию данные сохраняются в `authorized_contacts.jsonl` (каждый контакт — отдельная строка JSON). Путь можно изменить, передав `contact_storage_path` в конструктор `TelegramWebhookHandler`. Формат записи включает `chat_id`, данные контакта, автора сообщения и таймстемп.

Регулярно архивируйте файл или перенаправляйте запись во внешнюю систему, если обрабатываете реальные персональные данные.

## Конвертация Excel

`convert_xls_bytes_to_xlsx_bytes` получает байты `.xls` или `.xlx`, сохраняет их во временной директории и запускает LibreOffice в headless-режиме:

1. Обработчик проверяет расширение (`.xls`/`.xlx`), скачивает файл из Telegram через `getFile` и передаёт байты в `xls_to_xlsx`.
2. Модуль формирует команду `soffice --headless --convert-to xlsx --outdir <temp>` (путь к бинарнику берётся из `SOFFICE_BIN` или из `PATH`).
3. Полученный `.xlsx` считывается обратно и отправляется пользователю через `sendDocument`.

На каждом шаге в `TelegramWebhookHandler` выводятся логи `INFO` уровня (`Шаг 1`–`Шаг 4`), чтобы упростить диагностику конвертации.

Если LibreOffice не установлен или не найден, функция возвращает контролируемое исключение, а бот сообщает пользователю о недоступности конвертации. При необходимости можно заменить вызов CLI на интеграцию с внешним сервисом или очередь заданий — интерфейс модуля остаётся прежним.

## Контроль качества

- Включайте подробное логирование, установив `TELEGRAM_LOG_LEVEL=DEBUG` в окружении.
- Поддерживайте документацию в `docs/` в актуальном состоянии, чтобы агенты могли быстрее планировать задачи и экономить токены.
- При добавлении новых сценариев обновляйте тесты и описывайте их в [архитектурном обзоре](architecture.md).


# Процессы разработки

Этот документ описывает практические шаги для локальной работы с проектом: подготовку окружения, запуск приложения, тестирование и обслуживание вспомогательных файлов.

## Предварительные требования

- Python 3.11+ (используются аннотации `|` и `from __future__ import annotations`).
- Системные библиотеки для сборки пакетов Python (Linux: `build-essential`, `libffi-dev`, `libxml2-dev`, `libxslt-dev` при необходимости).
- Установленное и активированное виртуальное окружение (`python -m venv .venv && source .venv/bin/activate`).
- Доступ к Telegram Bot API (токен, выданный `@BotFather`) — обязателен для сценариев скачивания/отправки файлов.

## Установка зависимостей

```bash
pip install --upgrade pip
pip install -r requirements.txt
```

Файл `requirements.txt` содержит библиотеки для Flask-приложения, работы с Telegram и конвертации Excel.

## Запуск приложения

Минимальный запуск (использует `main.py`, где подключён полноценный обработчик вебхуков):

```bash
export TELEGRAM_BOT_TOKEN="<ваш_бот_токен>"   # нужен для сценариев с файлами
export FLASK_APP=main.py
flask run --host=0.0.0.0 --port=8000
```

Или напрямую через Python:

```bash
python main.py
```

Эндпоинты:

- `POST /webhook` — принимает апдейты Telegram.
- `GET /` — health-check, возвращает `{ "status": "running" }`.

При развёртывании убедитесь, что Telegram настроен на ваш публичный URL (`webhook_setup.py` можно использовать как пример скрипта регистрации вебхука).

## Тестирование

Проект поставляется с юнит- и интеграционными тестами. Рекомендуем использовать `pytest`, чтобы корректно обрабатывались и `assert`, и `unittest`-классы:

```bash
pytest
```

Альтернативно можно запустить стандартный `unittest`:

```bash
python -m unittest
```

Запускайте тесты перед коммитами и после значимых изменений текстов или конвертера Excel.

## Работа с текстами

- Основные тексты живут в `texts.json`. Структура файла:
  ```json
  {
    "greeting_text": "Приветствие",
    "authorize_button_text": "Подпись кнопки",
    "contact_saved_template": "Шаблон {contact_label}"
  }
  ```
- Если файл отсутствует или повреждён, используются значения `DEFAULT_TEXTS` из `texts.py`.
- Шаблон `contact_saved_template` поддерживает плейсхолдер `{contact_label}`. Если форматирование падает, код автоматически подставит дефолтный шаблон.

## Хранение контактов

По умолчанию данные сохраняются в `authorized_contacts.jsonl` (каждый контакт — отдельная строка JSON). Путь можно изменить, передав `contact_storage_path` в конструктор `TelegramWebhookHandler`. Формат записи включает `chat_id`, данные контакта, автора сообщения и таймстемп.

Регулярно архивируйте файл или перенаправляйте запись во внешнюю систему, если обрабатываете реальные персональные данные.

## Конвертация Excel

Функция `convert_xls_bytes_to_xlsx_bytes` используется, когда пользователь присылает `.xls` файл:

1. Бот через `getFile` получает временный URL.
2. Файл скачивается и передаётся в конвертер.
3. Результат загружается обратно через `sendDocument`.

При отсутствии конвертера (например, если пакет `xlwt` не установлен) бот ответит сообщением об ошибке. Для улучшения UX можно дорабатывать `_handle_document_message`, например, добавив очередь задач или интеграцию с внешним конвертером.

## Контроль качества

- Включайте подробное логирование, установив `TELEGRAM_LOG_LEVEL=DEBUG` в окружении.
- Поддерживайте документацию в `docs/` в актуальном состоянии, чтобы агенты могли быстрее планировать задачи и экономить токены.
- При добавлении новых сценариев обновляйте тесты и описывайте их в [архитектурном обзоре](architecture.md).


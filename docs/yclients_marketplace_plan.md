# План интеграции с маркетплейсом Yclients

_Основано на требованиях статей 67, 68 и 189._

## Цели интеграции

1. **Онбординг из Telegram в маркетплейс услуг.** Пользователи, отправившие контактные данные боту, должны получать подборку услуг и свободных слотов из Yclients без перехода в дополнительные интерфейсы.
2. **Синхронизация записей и профилей.** Контакт, сохранённый ботом, должен конвертироваться в карточку клиента Yclients и автоматически привязываться к созданным записям.
3. **Расширение платёжных и маркетинговых сценариев.** Маркетплейс предоставляет витрину акций, программы лояльности и оплату онлайн; бот должен сообщать о доступных опциях и перенаправлять в Yclients при необходимости.
4. **Прозрачная аналитика.** Все заявки, сформированные через бот, логируются и маркируются источником `telegram_bot` для дальнейшей отчётности в Yclients и BI-инструментах.

## Необходимые API Yclients

| Цель | API и эндпоинты | Примечания |
| --- | --- | --- |
| Аутентификация партнёра | `POST /api/v1/auth` | Возвращает временный bearer-токен. Требует `partner_id`, `partner_token`, а также `login`/`password` менеджера компании при необходимости. |
| Получение справочников | `GET /api/v1/company/{company_id}/services`, `GET /api/v1/company/{company_id}/staff`, `GET /api/v1/company/{company_id}/seances` | Используется для формирования меню услуг, фильтрации по сотрудникам и вывода свободных слотов. |
| Управление клиентами | `POST /api/v1/company/{company_id}/clients`, `GET /api/v1/company/{company_id}/clients/search` | Создание или поиск клиента по телефону из Telegram. |
| Создание и управление записью | `POST /api/v1/company/{company_id}/records`, `GET /api/v1/company/{company_id}/records/{record_id}`, `DELETE /api/v1/company/{company_id}/records/{record_id}` | Создание записи, получение статуса, отмена по запросу пользователя. |
| Маркетинговые предложения | `GET /api/v1/company/{company_id}/promos` | Подборка акций и специальных предложений для ответа в чате. |
| Уведомления | Вебхуки `record.create`, `record.confirm`, `record.cancel`, `client.update` | Настраиваются в личном кабинете Yclients. Используются для уведомлений и синхронизации статусов в Telegram. |

При необходимости дополнительно используются метод `GET /api/v1/timezone` (для приведения времени к часовому поясу компании) и сервис экспорта отчётов.

## Схема обмена данными

1. **Сбор контакта.** Пользователь отправляет номер телефона через кнопку «Поделиться контактом». Бот сохраняет его локально и инициирует запрос `clients/search`. При отсутствии записи создаёт клиента (`clients`).
2. **Получение каталога услуг.** На основании результата `services` формируется инлайн-меню с категориями. При выборе услуги бот обращается к `seances` с фильтром по услуге и сотруднику.
3. **Бронирование.** После подтверждения даты и времени создаётся запись (`records`). Ответ Yclients содержит `record_id`, который сохраняется в состоянии диалога.
4. **Подтверждение и уведомления.** Бот отправляет пользователю финальное подтверждение и, при необходимости, ссылку на оплату из ответа Yclients. Далее бот ожидает вебхук `record.confirm`/`record.cancel`, чтобы актуализировать статус в чате.
5. **Аналитика.** Каждая успешная запись логируется с меткой источника и сохраняется в хранилище бота (например, `authorized_contacts.jsonl` или внешняя БД), после чего данные можно выгружать для аналитики.

Диаграмма последовательности (словесно):

```
Пользователь → Telegram Bot → (сохранение контакта) → Yclients API (clients)
Пользователь ← Telegram Bot ← (список услуг) ← Yclients API (services)
Пользователь → Telegram Bot → (подтверждение слота) → Yclients API (records)
Yclients Webhook → Railway (Flask) → Telegram Bot → Пользователь (уведомление)
```

## Требования к инфраструктуре и секретам

- **Railway переменные окружения**
  - `YCLIENTS_PARTNER_ID`, `YCLIENTS_PARTNER_TOKEN` — реквизиты партнёра для получения bearer-токена.
  - `YCLIENTS_LOGIN`, `YCLIENTS_PASSWORD` — учётные данные салона (если используется auth с логином).
  - `YCLIENTS_COMPANY_ID`, `YCLIENTS_BRANCH_ID` — идентификаторы компании и филиала.
  - `YCLIENTS_WEBHOOK_SECRET` — токен для проверки подписи входящих вебхуков.
- **Хранилище состояния**
  - Необходимо добавить либо облачную БД (например, PostgreSQL на Railway) для хранения сопоставления `telegram_user_id ↔ yclients_client_id ↔ record_id`, либо расширить существующий JSONL/Redis.
  - Логи API-запросов и ответов стоит направлять в централизованное хранилище (Railway Logs, Sentry, ELK) для аудита.
- **Сетевые требования**
  - Разрешить исходящие HTTPS-запросы на `https://api.yclients.com`. Приём вебхуков — публичный HTTPS-эндпоинт Railway (например, `/yclients/webhook`).
  - Ограничить доступ к вебхуку через валидацию IP Yclients и подписи `YCLIENTS_WEBHOOK_SECRET`.
- **Безопасность и мониторинг**
  - Ротация токенов не реже одного раза в 90 дней (требование статьи 189).
  - Лимитировать количество запросов в минуту (указано в статье 68) с помощью локального rate limiter'а или очереди задач.
  - Журналировать успешные и ошибочные вызовы для последующего расследования инцидентов (требование статьи 67).

Следующие шаги: подготовить спецификацию диалоговых сценариев, реализовать клиент Yclients, покрыть интеграцию тестами и обновить Terraform/CLI-конфигурацию Railway переменных окружения.
